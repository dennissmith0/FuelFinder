<!DOCTYPE html>
<html>
<head>
    <title>Salt Lake</title>
    <style>
        /* Set the size of your map */
        #gmp-map {
            height: 500px;
            width: 700px;
        }
    </style>
</head>
<body>

<div style="display: flex;">
    <div style="width: 50%;">
        <div id="gmp-map"></div>
        <button id="get-distance">Get Distance & Duration</button>
        <select id="refinery-select">
            <option value="-1">Select a Refinery:</option>
            <option value="0">Silver Eagle Refining</option>
            <option value="1">Chevron Refinery</option>
            <option value="2">Big West Oil LLC</option>
            <option value="3">Holly Refining Co.</option>
        </select>
        <select id="gas-station-select">
            <option value="-1">Select a Site:</option>
            <option value="0">Sinclair (Sugarhouse)</option>
            <option value="1">Maverik (Draper)</option>
            <option value="2">Sinclair (Foothill)</option>
            <option value="3">Maverik (Downtown)</option>
            <option value="4">Maverik (South Jordan)</option>
        </select>
        <div id="output"></div>
    </div>
    <div style="width: 50%; margin-left: 20px;">
        <button id="get-fuel">Get Fuel Amounts</button>
        <div id="fuel-output"></div>
        <div id="refineries-list"></div>
        <div id="gas-stations-list"></div>
        <button id="generate-orders">Generate Orders</button>
        <div id="potential-orders"></div>
    </div>
</div>

<script>
"use strict";

let refineries;
let gasStations;

// define location of refineries & sites 
let directionsService, directionsRenderer;

function initMap() {
  const map = new google.maps.Map(document.getElementById("gmp-map"), {
    zoom: 10,
    center: { lat: 40.7608, lng: -111.8910 },
  });

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();
  directionsRenderer.setMap(map);
  
  refineries = [
    { lat: 40.86740493774414, lng: -111.91154479980469, title:"Silver Eagle Refining" },
    { lat: 40.82986068725586, lng: -111.93464660644531, title:"Chevron Refinery"},
    { lat: 40.841678619384766, lng: -111.92097473144531, title:"Big West Oil LLC"},
    { lat: 40.88388442993164, lng: -111.90167236328125, title:"Holly Refining Co."}
    // ... add the other refinery coordinates and titles here
  ];

  gasStations = [
    { lat: 40.73373794555664, lng: -111.85363006591797, title:"Sinclair (Sugarhouse)"},
    { lat: 40.54389572143555, lng: -111.87120819091797, title:"Maverik (Draper)"},
    { lat: 40.741390228271484, lng: -111.82665252685547, title:"Sinclair (Foothill)"},
    { lat: 40.76228332519531, lng: -111.87633514404297, title:"Maverik (Downtown)"},
    { lat: 40.53744888305664, lng: -111.9775619506836, title:"Maverik (South Jordan)"}
  ];

    let currentMarker;
    document.getElementById("refinery-select").addEventListener("change", function() {
    const selectedRefinery = refineries[this.value];
    if (currentMarker) {
        currentMarker.setMap(null);
    }
    if (this.value == "") return;
    currentMarker = new google.maps.Marker({
        position: selectedRefinery,
        map,
        title: selectedRefinery.title,
        });
    });

    let gasStationMarker;
    document.getElementById("gas-station-select").addEventListener("change", function() {
    const selectedGasStation = gasStations[this.value];
    if (gasStationMarker) {
        gasStationMarker.setMap(null);
    }
    if (this.value == "") return;
    gasStationMarker = new google.maps.Marker({
        position: selectedGasStation,
        map,
        title: selectedGasStation.title,
        });
    });
}

// Fetch distance and duration between a refinery and a site from the Distance Matrix API
document.getElementById("get-distance").addEventListener("click", async function() {
    const selectedRefineryIndex = document.getElementById("refinery-select").value;
    const selectedGasStationIndex = document.getElementById("gas-station-select").value;
    
    if (selectedRefineryIndex == "-1" || selectedGasStationIndex == "-1") {
        alert("Please select both a refinery and a gas station.");
        return;
    }

    const selectedRefinery = refineries[selectedRefineryIndex];
    const selectedGasStation = gasStations[selectedGasStationIndex];

    try {
        const distanceAndDuration = await displayDistanceAndDuration(selectedRefinery, selectedGasStation);
        const outputDiv = document.getElementById('output');
        outputDiv.innerHTML = `Distance: ${distanceAndDuration.distance}, Duration: ${distanceAndDuration.duration}`;
    } catch (error) {
        console.error("Failed to get distance and duration:", error);
    }

    const request = {
        origin: new google.maps.LatLng(selectedRefinery.lat, selectedRefinery.lng),
        destination: new google.maps.LatLng(selectedGasStation.lat, selectedGasStation.lng),
        travelMode: google.maps.TravelMode.DRIVING,
    };

    directionsService.route(request, function(result, status) {
        if (status == google.maps.DirectionsStatus.OK) {
            directionsRenderer.setDirections(result);
        } else {
            window.alert('Directions request failed due to ' + status);
        }
    });
});


async function displayDistanceAndDuration(origin, destination) {
    return new Promise((resolve, reject) => {
        const service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix(
            {
                origins: [new google.maps.LatLng(origin.lat, origin.lng)],
                destinations: [new google.maps.LatLng(destination.lat, destination.lng)],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.IMPERIAL,
            }, 
            (response, status) => {
                if (status === google.maps.DistanceMatrixStatus.OK) {
                    const results = response.rows[0].elements[0];
                    resolve({ distance: results.distance.text, duration: results.duration.text });
                } else {
                    reject(new Error(`Failed to fetch distance and duration: ${status}`));
                }
            }
        );
    });
    console.log('Distance and Duration:', { distance: results.distance.text, duration: results.duration.text });
    resolve({ distance: results.distance.text, duration: results.duration.text });
   
}


let ordersGenerated = false; // Flag to track if orders have been generated

// We estimated the daily fuel capacities of refineries using available data.
// Typically, a barrel of crude oil (42 gallons) yields about 19 gallons of gasoline.
// For three refineries, we found their crude oil processing capacity and estimated the gasoline
// production. However, for Silver Eagle Refining, we lacked specific data, so we took an average
// of the daily gasoline capacities of the other three refineries to estimate its fuel amount.

// Get Fuel amounts
function assignFuelAmounts() {
    const maxFuelAmounts = {
        "Holly Refining Co.": 850500 / 8,
        "Big West Oil LLC": 661500 / 3,
        "Chevron Refinery": 1067000 / 3,
        "Silver Eagle Refining": (1067000 / 3 + 661500 / 3 + 850500 / 3) / 3 // no info on barrels/day. Average the other 3
    };

    refineries.forEach((refinery) => {
        const maxFuel = maxFuelAmounts[refinery.title];
        refinery.fuelAmount = Math.floor(Math.random() * (maxFuel + 1));
    });

    gasStations.forEach(station => {
        station.fuelAmount = Math.floor(Math.random() * 24001);  // Random value between 0 and 30000 gallons
    });
}

document.getElementById("get-fuel").addEventListener("click", function() {
    assignFuelAmounts();
    ordersGenerated = true; // Set the flag to true after generating fuel amounts

    let refineriesOutput = "<h3>Refineries</h3><ul>";
    refineries.forEach(refinery => {
        refineriesOutput += `<li>${refinery.title}: ${refinery.fuelAmount} gallons</li>`;
    });
    refineriesOutput += "</ul>";

    let gasStationsOutput = "<h3>Gas Stations</h3><ul>";
    gasStations.forEach(gasStation => {
        gasStationsOutput += `<li>${gasStation.title}: ${gasStation.fuelAmount} gallons</li>`;
    });
    gasStationsOutput += "</ul>";

    document.getElementById("refineries-list").innerHTML = refineriesOutput;
    document.getElementById("gas-stations-list").innerHTML = gasStationsOutput;
});

// Generate potential orders based on fuel amounts 
document.getElementById("generate-orders").addEventListener("click", async function() {
    // Ensure we have fuel amounts
    if (!refineries || !gasStations) {
        alert("Please click 'Get Fuel Amounts' first to generate fuel amounts.");
        return;
    }

    const maxGasStationCapacity = 24000; // Max capacity for a gas station
    const orders = [];

    for (const gasStation of gasStations) {
        let gallonsNeeded = maxGasStationCapacity - gasStation.fuelAmount;
        if (gallonsNeeded <= 0) continue;

        let closestRefinery = null;
        let closestDistance = Number.MAX_VALUE;
        let closestDuration = "";

        for (const refinery of refineries) {
            if (refinery.fuelAmount < gallonsNeeded) continue;

            try {
                const distanceAndDuration = await displayDistanceAndDuration(refinery, gasStation);
                
                const distance = parseFloat(distanceAndDuration.distance.replace(" mi", ""));
                
                if (distance < closestDistance) {
                    closestDistance = distance;
                    closestRefinery = refinery;
                    closestDuration = distanceAndDuration.duration;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        if (closestRefinery) {
            orders.push({
                gasStation: gasStation,
                refinery: closestRefinery,
                distance: closestDistance,
                duration: closestDuration,
                gallonsToFill: gallonsNeeded,
            });
        }
    }

    // Display the generated orders
    const ordersOutput = document.getElementById("potential-orders");
    ordersOutput.innerHTML = "<h3>Potential Orders</h3>";
    orders.forEach(order => {
        ordersOutput.innerHTML += `
            <p>Gas Station: ${order.gasStation.title}</p>
            <p>Refinery: ${order.refinery.title}</p>
            <p>Distance: ${order.distance} miles</p>
            <p>Duration: ${order.duration}</p>
            <p>Gallons to Fill: ${order.gallonsToFill} gallons</p>
            <hr>
        `;
    });
});



</script>

<script src="config.js"></script>
<!--<script src="https://maps.googleapis.com/maps/api/js?key={API_KEY}&callback=initMap&libraries=&v=weekly" async></script>
 -->
<!-- Add Google Maps JavaScript API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkS4zu5MoOmw20zz7V_NEu1k_ZPJ-gH_0&callback=initMap&libraries=&v=weekly" async></script>
<!-- Add Directions API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkS4zu5MoOmw20zz7V_NEu1k_ZPJ-gH_0&callback=initMap&libraries=&v=weekly,directions" async></script>

</body>
</html>
